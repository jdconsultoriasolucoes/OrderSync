<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Confirmação de Pedido</title>
  <link rel="stylesheet" href="/static/tabela_preco/pedido_cliente.css?v=20251013a">
</head>
<body>
  <div class="documento">
    <header>
      <div class="logo-cliente">
        <img src="/static/tabela_preco/logo_cliente_supra.png" alt="Logo do Cliente">
      </div>
      <div class="dados-header">
        <h1>Proposta Comercial</h1>
        <div class="meta-link" style="font-size:12px;color:#666;margin-top:4px;">
          Data do pedido: <span id="datadopedido">—</span>
        </div>
        <p><strong>Cliente:</strong> <span id="razaoSocialCliente">---</span></p>
        <p><strong>Validade:</strong> <span id="validadeTabela">---</span> (<span id="tempoRestante">---</span>)</p>
        <p><strong id="labelEntregaRetirada">Data:</strong> <span id="dataEntregaValor">a combinar</span></p> 
      </div>
    </header>

    <main>
      <table id="tabelaProdutos">
        <thead>
          <tr>
            <th>Código</th>
            <th>Produto</th>
            <th>Embalagem</th>
            <th>Condição de Pagamento</th>
            <th>Peso</th>
            <th>Valor <span id="tituloValorFrete">c/ Frete</span></th>
            <th>Quantidade</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <section id="resumoPedido" class="resumo-pedido">
        <div class="resumo-grid">
          <div><strong>Peso total:</strong> <span id="totalPesoPedido">0</span> kg</div>
          <div><strong>Frete no pedido:</strong> <span id="totalFretePedido">R$ 0,00</span></div>
        </div>
      </section>
      <div class="total">
        <p><strong>Total:</strong> R$ <span id="totalGeral">0,00</span></p>
      </div>
      <section id="observacoesPedido" class="observacoes-pedido">
        <label for="observacaoCliente" class="observacoes-label">
          <strong>Observações do pedido</strong> <small>(opcional)</small>
        </label>

        <textarea id="observacaoCliente" maxlength="244" rows="4" class="observacoes-textarea"></textarea>

        <div id="obsCounter" class="observacoes-counter">0/244</div>
      </section>
      <div class="acoes">
        <button id="btnConfirmar">Confirmar Pedido</button>
        <button id="btnCancelar">Cancelar</button>
      </div>
     
      <div class="marca-dagua">
        <img src="/static/tabela_preco/logo.png" alt="Marca d'água OrderSync">
       </div>
      <p id="mensagem"></p>
    </main>
  </div>

  <!-- defina sua API (ajuste para prod) -->
<script>
  window.API_BASE = window.API_BASE || "https://ordersync-backend-edjq.onrender.com";
</script>
<script src="/static/tabela_preco/pedido_cliente.js?v=20251012b"></script>
<!-- resolve o /p/{code} e expõe os globais -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const API = (p) => `${(window.API_BASE || location.origin).replace(/\/$/,'')}${p}`;
    const code = location.pathname.split('/').pop();

   fetch(API(`/link_pedido/resolver?code=${encodeURIComponent(code)}`), { cache:'no-store' })
      .then(r => { if (!r.ok) throw new Error('resolver '+r.status); return r.json(); })
      .then(d => {
        window.currentTabelaId  = d.tabela_id;
        window.currentComFrete  = d.com_frete;
        window.entregaISO       = (typeof d.data_prevista === 'string' ? d.data_prevista : null); // << NOVO
        console.log('[resolver] ok', d);

        if (typeof window.carregarPedido === 'function') {
          window.carregarPedido();
        } else {
          setTimeout(() => window.carregarPedido && window.carregarPedido(), 0);
        }
      })
      .catch(err => console.error('[resolver] fail', err));
  });
</script>

  <div id="confirmModal" class="modal" hidden>
  <div class="modal-backdrop"></div>
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <h2 id="confirmTitle">Pedido confirmado ✅</h2>
    <p class="confirm-text">Recebemos seu pedido e ele já está sendo processado.</p>
    <p id="confirmPedidoInfo" class="confirm-info"></p>
    <button id="btnFecharConfirm" class="btn-modal">Fechar</button>
  </div>
</div>
</body>
</html>