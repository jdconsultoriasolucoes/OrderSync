<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Confirmação de Pedido</title>
  <link rel="stylesheet" href="/static/tabela_preco/pedido_cliente.css">
</head>
<body>
  <div class="documento">
    <header>
      <div class="logo-cliente">
        <img src="/static/tabela_preco/assets/logo_cliente_supra.png" alt="Logo do Cliente">
      </div>
      <div class="dados-header">
        <h1>Proposta Comercial</h1>
        <p><strong>Cliente:</strong> <span id="cnpjCliente">---</span> - <span id="razaoSocialCliente">---</span></p>
        <p><strong>Validade:</strong> <span id="validadeTabela">---</span> (<span id="tempoRestante">---</span>)</p>
      </div>
    </header>

    <main>
      <table id="tabelaProdutos">
        <thead>
          <tr>
            <th>Código</th>
            <th>Produto</th>
            <th>Embalagem</th>
            <th>Condição de Pagamento</th>
            <th>Peso</th>
            <th>Valor <span id="tituloValorFrete">c/ Frete</span></th>
            <th>Quantidade</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="total">
        <p><strong>Total:</strong> R$ <span id="totalGeral">0,00</span></p>
      </div>

      <div class="acoes">
        <button id="btnConfirmar">Confirmar Pedido</button>
        <button id="btnCancelar">Cancelar</button>
      </div>
     
      <div class="marca-dagua">
        <img src="/static/tabela_preco/assets/logo.png" alt="Marca d'água OrderSync">
       </div>
      <p id="mensagem"></p>
    </main>
  </div>

  <!-- defina sua API (ajuste para prod) -->
<script>
  window.API_BASE = window.API_BASE || "https://ordersync-backend-edjq.onrender.com";
</script>
<script src="/static/tabela_preco/pedido_cliente.js"></script>
<!-- resolve o /p/{code} e expõe os globais -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const API = (p) => `${(window.API_BASE || location.origin).replace(/\/$/,'')}${p}`;
    const code = location.pathname.split('/').pop();

    fetch(API(`/link_pedido/resolver?code=${encodeURIComponent(code)}`), { cache:'no-store' })
      .then(r => { if (!r.ok) throw new Error('resolver '+r.status); return r.json(); })
      .then(d => {
        // 1) define os globais que seu JS usa como fallback
        window.currentTabelaId  = d.tabela_id;
        window.currentComFrete  = d.com_frete;
        console.log('[resolver] ok', d);

        // 2) chama o fluxo principal SÓ AGORA
        if (typeof window.carregarPedido === 'function') {
          window.carregarPedido();
        } else {
          // se por algum motivo o script ainda não registrou a função, tenta novamente
          setTimeout(() => window.carregarPedido && window.carregarPedido(), 0);
        }
      })
      .catch(err => console.error('[resolver] fail', err));
  });
</script>

  
</body>
</html>